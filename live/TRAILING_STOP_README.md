# 移动止损功能说明

## 功能概述

移动止损（Trailing Stop）是一种动态风险管理工具，它会根据价格走势自动调整止损位置，在保护利润的同时允许持仓继续获利。

## 工作原理

### 1. 激活条件
- 多头持仓：当价格超过入场价 + (ATR × 激活阈值) 时激活
- 空头持仓：当价格低于入场价 - (ATR × 激活阈值) 时激活

### 2. 移动逻辑
- **多头持仓**：移动止损只能向上移动，跟随价格上涨
- **空头持仓**：移动止损只能向下移动，跟随价格下跌

### 3. 触发条件
- 当价格回撤到移动止损位置时，自动平仓

## 配置参数

在 `conf/config.yml` 中的 `risk.trailing_stop` 部分：

```yaml
trailing_stop:
  enabled: true                    # 是否启用移动止损
  activation_threshold: 1.0        # 激活阈值（ATR倍数）
  distance_multiplier: 1.5         # 移动止损距离倍数
  min_distance: 0.01              # 最小距离（价格百分比）
  max_distance: 0.05              # 最大距离（价格百分比）
  update_frequency: 60             # 更新频率（秒）
```

## 使用示例

### 场景1：多头持仓
```
入场价: 5.0 USDT
ATR: 0.1
激活阈值: 1.0 ATR = 0.1
移动止损距离: 1.5 ATR = 0.15

价格走势:
5.0 → 5.2 (激活移动止损: 5.05)
5.2 → 5.5 (移动止损跟随: 5.35)
5.5 → 5.3 (触发移动止损，平仓)
```

### 场景2：空头持仓
```
入场价: 5.0 USDT
ATR: 0.1
激活阈值: 1.0 ATR = 0.1
移动止损距离: 1.5 ATR = 0.15

价格走势:
5.0 → 4.8 (激活移动止损: 4.95)
4.8 → 4.5 (移动止损跟随: 4.65)
4.5 → 4.7 (触发移动止损，平仓)
```

## 技术实现

### 核心类和方法

1. **Position类** - 新增移动止损字段：
   - `trailing_stop`: 当前移动止损价格
   - `trailing_stop_activated`: 是否已激活
   - `highest_price`: 多头最高价
   - `lowest_price`: 空头最低价
   - `trailing_distance`: 移动止损距离

2. **RiskManager类** - 核心逻辑：
   - `update_trailing_stop()`: 更新移动止损
   - `initialize_trailing_stop()`: 初始化移动止损

3. **LiveTradingSystem类** - 集成检查：
   - `check_trailing_stops()`: 检查移动止损触发

### 数据持久化

移动止损状态保存在 `live/trading_state.json` 文件中，确保系统重启后能恢复状态。

## 优势

1. **保护利润**：锁定已实现的利润
2. **允许获利**：不限制价格上涨空间
3. **动态调整**：根据市场波动自动调整
4. **风险控制**：防止大幅回撤

## 注意事项

1. **市场波动**：在震荡市场中可能频繁触发
2. **滑点影响**：实际成交价格可能与移动止损价格有差异
3. **网络延迟**：需要稳定的网络连接确保及时执行
4. **配置调优**：需要根据具体交易品种调整参数

## 测试验证

运行测试脚本验证功能：

```bash
python live/test_trailing_stop.py
```

## 监控和日志

系统会记录以下关键事件：
- 移动止损激活
- 移动止损价格更新
- 移动止损触发平仓

日志示例：
```
🔄 移动止损激活: 价格=5.2000, 移动止损=5.0500
🔄 移动止损更新: 价格=5.5000, 移动止损=5.3500
🚨 移动止损触发: 价格=5.3000, 移动止损=5.3500
```

## 最佳实践

1. **参数调优**：根据历史数据回测确定最佳参数
2. **风险控制**：结合其他风险管理工具使用
3. **监控告警**：设置移动止损触发告警
4. **定期评估**：根据市场环境调整策略
